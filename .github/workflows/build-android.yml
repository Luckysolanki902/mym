name: Build Android APK

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      release_message:
        description: 'Release message (leave empty for no release)'
        required: false
        default: ''

permissions:
  contents: write

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if this is a release commit
        id: check-release
        run: |
          # Get the first line of the commit message
          COMMIT_MSG=$(echo "${{ github.event.head_commit.message }}" | head -n 1)
          MANUAL_MSG="${{ github.event.inputs.release_message }}"
          
          echo "Commit message: $COMMIT_MSG"
          
          # Check for release: prefix in commit message (case insensitive)
          if echo "$COMMIT_MSG" | grep -qi "^release:"; then
            echo "is_release=true" >> $GITHUB_OUTPUT
            # Extract the release message (everything after "release:")
            RELEASE_MSG=$(echo "$COMMIT_MSG" | sed 's/^[Rr]elease:[[:space:]]*//')
            echo "release_message=$RELEASE_MSG" >> $GITHUB_OUTPUT
            echo "This is a RELEASE commit!"
          elif [ -n "$MANUAL_MSG" ]; then
            echo "is_release=true" >> $GITHUB_OUTPUT
            echo "release_message=$MANUAL_MSG" >> $GITHUB_OUTPUT
            echo "Manual release triggered!"
          else
            echo "is_release=false" >> $GITHUB_OUTPUT
            echo "release_message=" >> $GITHUB_OUTPUT
            echo "Not a release commit"
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Create minimal web directory for Capacitor
        run: |
          mkdir -p out
          cat > out/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
            <title>Spyll</title>
            <style>
              * { margin: 0; padding: 0; box-sizing: border-box; }
              body { 
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                background: #121212;
                min-height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
              }
              .loader {
                text-align: center;
                color: #FF5973;
                font-size: 2rem;
                font-weight: 600;
              }
            </style>
          </head>
          <body>
            <div class="loader">SPYLL</div>
            <script>
              window.location.href = 'https://spyll.in';
            </script>
          </body>
          </html>
          EOF

      - name: Setup Java JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Capacitor CLI
        run: npm install -g @capacitor/cli

      - name: Add Android platform
        run: npx cap add android || true

      - name: Copy google-services.json
        run: |
          if [ -f "google-services.json" ]; then
            cp google-services.json android/app/google-services.json
          fi

      - name: Sync Capacitor
        run: npx cap sync android

      - name: Copy app icons (after sync to avoid overwrite)
        run: |
          # Copy icons to Android mipmap folders AFTER cap sync
          cp public/app-icons/icon-72x72.png android/app/src/main/res/mipmap-hdpi/ic_launcher.png
          cp public/app-icons/icon-72x72.png android/app/src/main/res/mipmap-hdpi/ic_launcher_round.png
          cp public/app-icons/icon-96x96.png android/app/src/main/res/mipmap-xhdpi/ic_launcher.png
          cp public/app-icons/icon-96x96.png android/app/src/main/res/mipmap-xhdpi/ic_launcher_round.png
          cp public/app-icons/icon-144x144.png android/app/src/main/res/mipmap-xxhdpi/ic_launcher.png
          cp public/app-icons/icon-144x144.png android/app/src/main/res/mipmap-xxhdpi/ic_launcher_round.png
          cp public/app-icons/icon-192x192.png android/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png
          cp public/app-icons/icon-192x192.png android/app/src/main/res/mipmap-xxxhdpi/ic_launcher_round.png
          # Create 48x48 for mdpi by resizing
          convert public/app-icons/icon-96x96.png -resize 48x48 android/app/src/main/res/mipmap-mdpi/ic_launcher.png || cp public/app-icons/icon-72x72.png android/app/src/main/res/mipmap-mdpi/ic_launcher.png
          cp android/app/src/main/res/mipmap-mdpi/ic_launcher.png android/app/src/main/res/mipmap-mdpi/ic_launcher_round.png
          # Remove adaptive icon XML to use PNG directly
          rm -rf android/app/src/main/res/mipmap-anydpi-v26
          echo "App icons copied!"

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Make gradlew executable
        run: chmod +x android/gradlew

      - name: Setup release keystore
        run: |
          # Decode keystore from base64 secret
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/spyll-release.keystore
          # Create keystore.properties for gradle
          echo "storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" > android/keystore.properties
          echo "keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}" >> android/keystore.properties
          echo "keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}" >> android/keystore.properties
          echo "storeFile=spyll-release.keystore" >> android/keystore.properties

      - name: Build Release APK
        run: |
          cd android
          ./gradlew assembleRelease --no-daemon

      - name: Prepare APK for distribution
        run: |
          # Find and copy the release APK (handles different naming patterns)
          echo "Looking for release APK..."
          ls -la android/app/build/outputs/apk/release/ || echo "Release folder not found"
          
          # Find any release APK in the output folder
          APK_PATH=$(find android/app/build/outputs/apk/release -name "*.apk" | head -1)
          
          if [ -z "$APK_PATH" ]; then
            echo "ERROR: No APK found in release folder"
            exit 1
          fi
          
          echo "Found APK: $APK_PATH"
          cp "$APK_PATH" ./app.apk
          
          # Verify APK is valid
          echo "APK size: $(ls -lh app.apk | awk '{print $5}')"
          
          # Use zipalign if available to optimize the APK
          if command -v zipalign &> /dev/null; then
            zipalign -v 4 app.apk app-aligned.apk && mv app-aligned.apk app.apk
          fi

      - name: Upload APK as artifact
        uses: actions/upload-artifact@v4
        with:
          name: spyll-apk
          path: app.apk
          retention-days: 30

      - name: Get next version tag
        if: steps.check-release.outputs.is_release == 'true' && github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        id: get-version
        run: |
          # Get the latest tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0")
          # Extract number and increment
          VERSION_NUM=$(echo "$LATEST_TAG" | sed 's/v//')
          if ! [[ "$VERSION_NUM" =~ ^[0-9]+$ ]]; then
            VERSION_NUM=0
          fi
          NEXT_VERSION=$((VERSION_NUM + 1))
          echo "version=v$NEXT_VERSION" >> $GITHUB_OUTPUT

      - name: Create Release
        if: steps.check-release.outputs.is_release == 'true' && github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        id: create-release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get-version.outputs.version }}
          name: Spyll ${{ steps.get-version.outputs.version }}
          body: |
            ## Spyll - India's Largest Anonymous Network
            
            ### Download
            ðŸ“± **[Download APK](https://github.com/${{ github.repository }}/releases/download/${{ steps.get-version.outputs.version }}/app.apk)**
            
            ### What's New
            ${{ steps.check-release.outputs.release_message }}
            
            ---
            ðŸŒ Website: [spyll.in](https://spyll.in)
          files: app.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete source code archives from release
        if: steps.check-release.outputs.is_release == 'true' && github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"
          # Get release ID
          RELEASE_ID=$(gh release view "$VERSION" --json id -q .id 2>/dev/null || echo "")
          if [ -n "$RELEASE_ID" ]; then
            # Delete source archives
            gh release delete-asset "$VERSION" "${{ github.event.repository.name }}-${VERSION#v}.zip" -y 2>/dev/null || true
            gh release delete-asset "$VERSION" "${{ github.event.repository.name }}-${VERSION#v}.tar.gz" -y 2>/dev/null || true
            gh release delete-asset "$VERSION" "Source code (zip)" -y 2>/dev/null || true
            gh release delete-asset "$VERSION" "Source code (tar.gz)" -y 2>/dev/null || true
            echo "Source archives deleted from release"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
